<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Vehicle Details</title>
		<link rel="icon" type="image/x-icon" href="/assets/favicon-D52-HnyD.png" />
		<style>
			.data-card {
				height: 100%;
			}
			.data-list {
				font-size: 13px;
			}
			.data-list dt {
				font-weight: 600;
				color: #666;
			}
			.data-list dd {
				margin-bottom: 8px;
				padding-bottom: 8px;
				border-bottom: 1px solid #eee;
				word-break: break-word;
			}
			.data-list dd:last-child {
				border-bottom: none;
			}
			.loading-spinner {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 2px solid #f3f3f3;
				border-top: 2px solid #dc3545;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			.thumbnail-row {
				display: flex;
				flex-wrap: nowrap;
				gap: 6px;
				padding-bottom: 10px;
				border-bottom: 1px solid #eee;
				overflow-x: auto;
				overflow-y: hidden;
				scrollbar-width: thin;
			}
			.thumbnail-row::-webkit-scrollbar {
				height: 6px;
			}
			.thumbnail-row::-webkit-scrollbar-thumb {
				background: #888;
				border-radius: 3px;
			}
			.thumbnail-row img {
				width: 60px;
				height: 45px;
				min-width: 60px;
				object-fit: cover;
				border-radius: 4px;
				border: 1px solid #ddd;
				cursor: pointer;
				transition: transform 0.2s;
			}
			.thumbnail-row img:hover {
				transform: scale(1.5);
				z-index: 10;
				position: relative;
			}
			.thumbnail-count {
				font-size: 11px;
				color: #888;
				white-space: nowrap;
				padding-left: 8px;
				align-self: center;
			}
			/* Collapse toggle styling */
			[data-bs-toggle="collapse"] .bi-chevron-down {
				transition: transform 0.2s;
			}
			[data-bs-toggle="collapse"][aria-expanded="true"] .bi-chevron-down {
				transform: rotate(180deg);
			}
			.data-list pre {
				max-height: 300px;
				overflow: auto;
			}
		</style>
		<script type="module" crossorigin src="/assets/bootstrap.esm-CgEsG6e6.js"></script>
		<script type="module" crossorigin src="/assets/bootstrap-init-CxX6viQq.js"></script>
		<link rel="stylesheet" crossorigin href="/assets/bootstrap-BcD6Ynyg.css">
		<link rel="stylesheet" crossorigin href="/assets/style-B8YMWBVd.css">
	</head>
	<body data-bs-theme="dark">
		<header>
			<nav class="navbar bg-body-tertiary border-bottom">
				<div class="container-fluid">
					<a class="navbar-brand" href="../">
						<img src="/assets/fom-app-logo-01-BJtslbT3.svg" alt="Logo" height="28" />
					</a>
					<span class="navbar-text">Vehicle Details Comparison</span>
				</div>
			</nav>
		</header>

		<main class="container-fluid py-4">
			<!-- Search -->
			<div class="row mb-4">
				<div class="col-md-3">
					<button class="btn btn-outline-secondary" onclick="history.back(1)">
						<i class="bi bi-arrow-left"></i> Back
					</button>
				</div>
				<div class="col-md-6">
					<div class="input-group">
						<span class="input-group-text"><i class="bi bi-search"></i></span>
						<input
							type="text"
							class="form-control"
							id="stockInput"
							placeholder="Enter Stock Number"
							autocomplete="off" />
						<button class="btn btn-danger" type="button" id="searchBtn">
							Load Details
						</button>
					</div>
				</div>
				<div class="col-md-3"></div>
			</div>

			<!-- Data Columns -->
			<div class="row" id="dataContainer" style="display: none">
				<!-- XML Cache Column -->
				<div class="col-md-6 mb-4">
					<div class="card data-card">
						<div
							class="card-header d-flex justify-content-between align-items-center">
							<span
								><i class="bi bi-file-earmark-code me-2"></i>XML Cache |
								<span class="badge text-bg-warning small mx-2"
									>Dealer Spike</span
								></span
							>
							<span class="badge bg-secondary" id="xmlStatus">Pending</span>
						</div>
						<div class="card-body overflow-auto" style="max-height: 70vh">
							<div id="xmlLoading" class="text-center py-4">
								<div class="loading-spinner"></div>
								<div class="mt-2 text-muted">Loading...</div>
							</div>
							<div
								id="xmlThumbnails"
								class="thumbnail-row mb-3"
								style="display: none"></div>
							<div id="xmlParsedDesc" style="display: none"></div>
							<dl class="data-list" id="xmlData" style="display: none"></dl>
							<div
								id="xmlError"
								class="alert alert-warning"
								style="display: none"></div>
						</div>
					</div>
				</div>

				<!-- Portal API Column -->
				<div class="col-md-6 mb-4">
					<div class="card data-card">
						<div
							class="card-header d-flex justify-content-between align-items-center">
							<span>
								<i class="bi bi-cloud-download me-2"></i>API
								<span class="badge text-bg-danger small mx-2"
									>Digital IQ Portal</span
								>
							</span>
							<span class="badge bg-secondary" id="apiStatus">Pending</span>
						</div>
						<div class="card-body overflow-auto" style="max-height: 70vh">
							<div id="apiLoading" class="text-center py-4">
								<div class="loading-spinner"></div>
								<div class="mt-2 text-muted">Loading...</div>
							</div>
							<div
								id="apiThumbnails"
								class="thumbnail-row mb-3"
								style="display: none"></div>
							<div id="apiParsedDesc" style="display: none"></div>
							<dl class="data-list" id="apiData" style="display: none"></dl>
							<div
								id="apiError"
								class="alert alert-warning"
								style="display: none"></div>
						</div>
					</div>
				</div>
			</div>

			<!-- Empty State -->
			<div class="row" id="emptyState">
				<div class="col text-center py-5 text-muted">
					<i class="bi bi-search" style="font-size: 48px"></i>
					<p class="mt-3">
						Enter a stock number to compare XML cache and Portal API data
					</p>
				</div>
			</div>
		</main>

		<script src="../js/xml-cache.js"></script>
		<script>
			/**
			 * Extract image URLs from data object.
			 * @param {object} data - Data object.
			 * @returns {string[]} Array of image URLs.
			 */
			function extractImages(data) {
				const images = [];
				if (!data) return images;

				// Check common image fields
				if (data.ImageUrl) images.push(data.ImageUrl);
				if (data.ImageURL) images.push(data.ImageURL);
				if (data.imageUrl) images.push(data.imageUrl);

				// Check for Images array (Portal API)
				if (Array.isArray(data.Images)) {
					data.Images.forEach((img) => {
						if (typeof img === "string") images.push(img);
						else if (img && img.ImgURL) images.push(img.ImgURL);
						else if (img && img.Url) images.push(img.Url);
						else if (img && img.url) images.push(img.url);
						else if (img && img.ImageUrl) images.push(img.ImageUrl);
						else if (img && img.ImageURL) images.push(img.ImageURL);
					});
				}

				// Check for ImageUrls array
				if (Array.isArray(data.ImageUrls)) {
					images.push(...data.ImageUrls.filter((u) => typeof u === "string"));
				}

				return [...new Set(images)]; // Remove duplicates
			}

			/**
			 * Render thumbnails HTML.
			 * @param {string[]} images - Array of image URLs.
			 * @returns {string} HTML string.
			 */
			function renderThumbnails(images) {
				if (!images || images.length === 0) return "";

				const thumbs = images
					.slice(0, 12)
					.map(
						(url) =>
							`<img src="${url}" alt="Vehicle" onerror="this.style.display='none'" />`
					)
					.join("");

				const countText =
					images.length > 12 ?
						`<div class="thumbnail-count">Showing 12 of ${images.length} images</div>`
					:	`<div class="thumbnail-count">${images.length} image${images.length !== 1 ? "s" : ""}</div>`;

				return thumbs + countText;
			}

			// Counter for unique collapse IDs
			let collapseCounter = 0;

			/**
			 * Render data object as definition list HTML.
			 * @param {object} data - Data object to render.
			 * @returns {string} HTML string.
			 */
			function renderDataList(data) {
				if (!data || typeof data !== "object") return "<p>No data</p>";

				let html = "";
				const keys = Object.keys(data).sort();

				for (const key of keys) {
					let value = data[key];

					// Handle arrays
					if (Array.isArray(value)) {
						if (value.length === 0) {
							value = "<em class='text-muted'>Empty array</em>";
						} else {
							const collapseId = `collapse-${collapseCounter++}`;
							const jsonContent = JSON.stringify(value, null, 2);
							value = `
                <button class="btn btn-sm btn-outline-secondary py-0 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
                  <i class="bi bi-code-square me-1"></i>${value.length} items <i class="bi bi-chevron-down ms-1 small"></i>
                </button>
                <div class="collapse mt-2" id="${collapseId}">
                  <pre class="mb-0 small bg-dark text-light p-2 rounded">${escapeHtml(jsonContent)}</pre>
                </div>
              `;
						}
					}
					// Handle objects
					else if (value && typeof value === "object") {
						const collapseId = `collapse-${collapseCounter++}`;
						const jsonContent = JSON.stringify(value, null, 2);
						const keyCount = Object.keys(value).length;
						value = `
              <button class="btn btn-sm btn-outline-secondary py-0 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
                <i class="bi bi-braces me-1"></i>${keyCount} keys <i class="bi bi-chevron-down ms-1 small"></i>
              </button>
              <div class="collapse mt-2" id="${collapseId}">
                <pre class="mb-0 small bg-dark text-light p-2 rounded">${escapeHtml(jsonContent)}</pre>
              </div>
            `;
					}
					// Handle null/undefined
					else if (value === null || value === undefined || value === "") {
						value = "<em class='text-muted'>null/empty</em>";
					}

					html += `<dt>${key}</dt><dd>${value}</dd>`;
				}

				return html;
			}

			/**
			 * Escape HTML special characters.
			 * @param {string} str - String to escape.
			 * @returns {string} Escaped string.
			 */
			function escapeHtml(str) {
				const div = document.createElement("div");
				div.textContent = str;
				return div.innerHTML;
			}

			/**
			 * Parse B50Desc field into Dealer Notes and Tech Specs.
			 * Splits at first <b> tag - dealer notes before, tech specs after.
			 * @param {string} desc - B50Desc field content (HTML).
			 * @returns {{dealerNotes: string, techSpecs: Array<{label: string, value: string}>}}
			 */
			function parseB50Desc(desc) {
				if (!desc) return { dealerNotes: "", techSpecs: [] };

				// Find the first <b> tag - everything before is dealer notes
				const firstBoldIndex = desc.search(/<b>/i);

				let dealerNotes = "";
				let techSpecsHtml = "";

				if (firstBoldIndex > 0) {
					// Split at first <b> tag
					dealerNotes = desc.substring(0, firstBoldIndex);
					techSpecsHtml = desc.substring(firstBoldIndex);
				} else if (firstBoldIndex === 0) {
					// Starts with tech specs, no dealer notes
					techSpecsHtml = desc;
				} else {
					// No <b> tags, everything is dealer notes
					dealerNotes = desc;
				}

				// Clean dealer notes - strip HTML tags
				dealerNotes = dealerNotes
					.replace(/<br\s*\/?>/gi, " ")
					.replace(/<[^>]+>/g, "")
					.replace(/\s+/g, " ")
					.trim();

				// Parse tech specs from <b>Label:</b> Value pattern
				const techSpecs = [];
				const specRegex =
					/<b>([^<]+):<\/b>\s*([^<]+?)(?:<\/br>|<br\s*\/?>|<b>|$)/gi;
				let match;

				while ((match = specRegex.exec(techSpecsHtml)) !== null) {
					const label = match[1].trim();
					const value = match[2].trim();
					if (label && value) {
						techSpecs.push({ label, value });
					}
				}

				return { dealerNotes, techSpecs };
			}

			/**
			 * Render parsed B50Desc sections.
			 * @param {string} desc - B50Desc field content.
			 * @returns {string} HTML string with Dealer Notes and Tech Specs sections.
			 */
			function renderParsedDesc(desc) {
				const { dealerNotes, techSpecs } = parseB50Desc(desc);
				let html = "";

				if (dealerNotes) {
					html += `
						<div class="card mb-3 border-warning">
							<div class="card-header bg-warning bg-opacity-25">
								<i class="bi bi-sticky me-2"></i>Dealer Notes
							</div>
							<div class="card-body small">
								<p class="mb-0">${escapeHtml(dealerNotes)}</p>
							</div>
						</div>
					`;
				}

				if (techSpecs.length > 0) {
					const specsHtml = techSpecs
						.map(
							(s) => `
						<tr>
							<td class="fw-semibold text-nowrap">${escapeHtml(s.label)}</td>
							<td>${escapeHtml(s.value)}</td>
						</tr>
					`
						)
						.join("");

					html += `
						<div class="card mb-3 border-info">
							<div class="card-header bg-info bg-opacity-25">
								<i class="bi bi-gear me-2"></i>Tech Specs
							</div>
							<div class="card-body p-0">
								<table class="table table-sm table-striped mb-0 small">
									<tbody>${specsHtml}</tbody>
								</table>
							</div>
						</div>
					`;
				}

				return html;
			}

			/**
			 * Load XML cache data for stock number.
			 * @param {string} stockNumber - Stock number to look up.
			 */
			async function loadXmlData(stockNumber) {
				const loading = document.getElementById("xmlLoading");
				const dataEl = document.getElementById("xmlData");
				const thumbsEl = document.getElementById("xmlThumbnails");
				const parsedDescEl = document.getElementById("xmlParsedDesc");
				const errorEl = document.getElementById("xmlError");
				const statusEl = document.getElementById("xmlStatus");

				loading.style.display = "block";
				dataEl.style.display = "none";
				thumbsEl.style.display = "none";
				parsedDescEl.style.display = "none";
				errorEl.style.display = "none";
				statusEl.className = "badge bg-secondary";
				statusEl.textContent = "Loading...";

				try {
					if (typeof window.getCachedXmlVehicle !== "function") {
						throw new Error("XML cache function not available");
					}

					const data = await window.getCachedXmlVehicle(stockNumber);

					if (data) {
						// Show thumbnails
						const images = extractImages(data);
						if (images.length > 0) {
							thumbsEl.innerHTML = renderThumbnails(images);
							thumbsEl.style.display = "flex";
						}

						// Parse and display Description as Dealer Notes and Tech Specs
						if (data.Description) {
							const parsedHtml = renderParsedDesc(data.Description);
							if (parsedHtml) {
								parsedDescEl.innerHTML = parsedHtml;
								parsedDescEl.style.display = "block";
							}
						}

						dataEl.innerHTML = renderDataList(data);
						dataEl.style.display = "block";
						statusEl.className = "badge bg-success";
						statusEl.textContent = `${Object.keys(data).length} fields`;
					} else {
						errorEl.textContent =
							"No data found in XML cache for this stock number.";
						errorEl.style.display = "block";
						statusEl.className = "badge bg-warning";
						statusEl.textContent = "Not Found";
					}
				} catch (error) {
					console.error("XML cache error:", error);
					errorEl.textContent = error.message;
					errorEl.style.display = "block";
					statusEl.className = "badge bg-danger";
					statusEl.textContent = "Error";
				} finally {
					loading.style.display = "none";
				}
			}

			/**
			 * Load Portal API data for stock number.
			 * @param {string} stockNumber - Stock number to look up.
			 */
			async function loadApiData(stockNumber) {
				const loading = document.getElementById("apiLoading");
				const dataEl = document.getElementById("apiData");
				const thumbsEl = document.getElementById("apiThumbnails");
				const parsedDescEl = document.getElementById("apiParsedDesc");
				const errorEl = document.getElementById("apiError");
				const statusEl = document.getElementById("apiStatus");

				loading.style.display = "block";
				dataEl.style.display = "none";
				thumbsEl.style.display = "none";
				parsedDescEl.style.display = "none";
				errorEl.style.display = "none";
				statusEl.className = "badge bg-secondary";
				statusEl.textContent = "Loading...";

				try {
					const response = await fetch(
						`https://newportal.flatoutmotorcycles.com/portal/public/api/majorunit/stocknumber/${stockNumber}`
					);

					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}

					const data = await response.json();

					if (data && Object.keys(data).length > 0) {
						// Show thumbnails
						const images = extractImages(data);
						if (images.length > 0) {
							thumbsEl.innerHTML = renderThumbnails(images);
							thumbsEl.style.display = "flex";
						}

						// Parse and display B50Desc as Dealer Notes and Tech Specs
						if (data.B50Desc) {
							const parsedHtml = renderParsedDesc(data.B50Desc);
							if (parsedHtml) {
								parsedDescEl.innerHTML = parsedHtml;
								parsedDescEl.style.display = "block";
							}
						}

						dataEl.innerHTML = renderDataList(data);
						dataEl.style.display = "block";
						statusEl.className = "badge bg-success";
						statusEl.textContent = `${Object.keys(data).length} fields`;
					} else {
						errorEl.textContent =
							"No data returned from Portal API for this stock number.";
						errorEl.style.display = "block";
						statusEl.className = "badge bg-warning";
						statusEl.textContent = "Not Found";
					}
				} catch (error) {
					console.error("Portal API error:", error);
					errorEl.textContent = error.message;
					errorEl.style.display = "block";
					statusEl.className = "badge bg-danger";
					statusEl.textContent = "Error";
				} finally {
					loading.style.display = "none";
				}
			}

			/**
			 * Load details for a stock number.
			 * @param {string} stockNumber - Stock number to load.
			 */
			function loadDetails(stockNumber) {
				if (!stockNumber || !stockNumber.trim()) return;

				stockNumber = stockNumber.trim().toUpperCase();
				document.getElementById("stockInput").value = stockNumber;

				// Update URL without adding history entry
				const url = new URL(window.location);
				url.searchParams.set("s", stockNumber);
				window.history.replaceState({}, "", url);

				// Show data container, hide empty state
				document.getElementById("dataContainer").style.display = "flex";
				document.getElementById("emptyState").style.display = "none";

				// Load both data sources in parallel
				loadXmlData(stockNumber);
				loadApiData(stockNumber);
			}

			// Initialize on page load
			document.addEventListener("DOMContentLoaded", () => {
				const stockInput = document.getElementById("stockInput");
				const searchBtn = document.getElementById("searchBtn");

				// Handle search button click
				searchBtn.addEventListener("click", () => {
					loadDetails(stockInput.value);
				});

				// Handle enter key
				stockInput.addEventListener("keypress", (e) => {
					if (e.key === "Enter") {
						loadDetails(stockInput.value);
					}
				});

				// Check URL for stock number
				const urlParams = new URLSearchParams(window.location.search);
				const stockNumber = urlParams.get("s") || urlParams.get("search");
				if (stockNumber) {
					loadDetails(stockNumber);
				}
			});
		</script>
	</body>
</html>
